###############################################################################
# prepare-env.conf
# Configuração principal do módulo prepare-env.sh
# Responsável por preparar, validar e configurar o ambiente Linux From Scratch
###############################################################################

### Diretórios principais #####################################################
# Caminho principal do sistema LFS (onde será montado o sistema base)
LFS="/mnt/lfs"

# Diretórios padrão criados automaticamente
LFS_TOOLS="$LFS/tools"
LFS_SOURCES="$LFS/sources"
LFS_BUILD="$LFS/build"
LFS_LOGS="$LFS/logs"
LFS_CACHE="$LFS/cache"
LFS_VAR="$LFS/var"
LFS_LOCKDIR="$LFS/var/lock"
LFS_PKGDB="$LFS/var/lib/pkg-db.sqlite"

### Usuário e permissões ######################################################
# Usuário padrão utilizado na construção inicial (fase 1)
LFS_USER="lfs"
LFS_GROUP="lfs"

# Shell padrão para o usuário LFS
LFS_SHELL="/bin/bash"

# Cria usuário automaticamente caso não exista (yes/no)
AUTO_CREATE_USER="yes"

# Define senha automática para o usuário lfs (opcional)
# Deixe em branco para manter sem senha
LFS_USER_PASS=""

# Permissões padrão de diretórios
DEFAULT_DIR_MODE="0755"
DEFAULT_FILE_MODE="0644"

### Ambiente e compilação #####################################################
# Define quantos jobs paralelos o make pode usar
LFS_JOBS="$(nproc)"

# Locale e ambiente POSIX
LC_ALL="POSIX"
LFS_TGT="$(uname -m)-lfs-linux-gnu"

# Caminho do compilador temporário
PATH_ADDITIONAL="$LFS/tools/bin:/usr/bin:/bin"

# Ambiente CHROOT seguro ######################################################
# Ativa preparação e execução dentro de chroot seguro
ENABLE_CHROOT="yes"

# Monta automaticamente os pseudo-filesystems (proc, sys, dev, run)
MOUNT_VIRTUAL_FS="yes"

# Desmonta automaticamente após finalização
AUTO_UMOUNT="yes"

# Isolamento de namespace (requer unshare)
ENABLE_NAMESPACE_ISOLATION="yes"

### Banco de dados e logging ##################################################
# Ativa integração com o módulo pkg-db
ENABLE_DB_LOG="yes"

# Caminho do módulo pkg-db.sh
PKG_DB_MODULE="/usr/local/bin/lfs-builder/modules/pkg-db.sh"

# Diretório de logs detalhados
LOG_DIR="$LFS_LOGS"

# Log principal do módulo
LOG_FILE="$LOG_DIR/prepare-env.log"

# Modo quiet: apenas progresso no rodapé
QUIET_MODE="no"

# Cores de log (usadas se QUIET_MODE=no)
COLOR_INFO="\033[1;32m"
COLOR_WARN="\033[1;33m"
COLOR_ERROR="\033[1;31m"
COLOR_RESET="\033[0m"

### Montagem e desmontagem ####################################################
# Lista de pseudo-filesystems a montar dentro do chroot
MOUNT_LIST=(
  "/dev"
  "/dev/pts"
  "/proc"
  "/sys"
  "/run"
)

# Flags de montagem
MOUNT_FLAGS_DEV="--bind"
MOUNT_FLAGS_PROC="-t proc proc"
MOUNT_FLAGS_SYS="-t sysfs sysfs"
MOUNT_FLAGS_RUN="-t tmpfs tmpfs"

### Segurança e travas ########################################################
# Caminho do arquivo de lock global
GLOBAL_LOCK="$LFS_LOCKDIR/lfs-env.lock"

# Política de rollback parcial em caso de erro (yes/no)
ROLLBACK_ON_ERROR="yes"

# Ações seguras (interrompe em caso de falha)
set -euo pipefail

### Informações do host #######################################################
# Checagem mínima de ferramentas essenciais
REQUIRED_TOOLS=(
  bash
  make
  gcc
  g++
  tar
  xz
  bzip2
  gzip
  patch
  wget
  rsync
  perl
  python3
  file
)

# Espaço mínimo em disco necessário em MB
MIN_DISK_MB=10000
# Memória mínima em MB
MIN_MEM_MB=2048

### Tempo e monitoramento #####################################################
# Intervalo (em segundos) para atualizar status de CPU, memória e disco
STATUS_UPDATE_INTERVAL=2

# Habilita medição de tempo total por etapa
ENABLE_TIMER="yes"

###############################################################################
# Fim do arquivo prepare-env.conf
###############################################################################
